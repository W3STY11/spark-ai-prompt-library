# ‚ö° COMPLETE SETUP GUIDE - SPARK M365 Copilot Integration

**Version:** 3.0.0 | **Updated:** 2025-10-21

## What This Does - NO MANUAL COPYING OR PASTING!

‚úÖ **Click "Copy to Copilot"** ‚Üí Prompt AUTOMATICALLY appears in M365 Copilot chatbox
‚úÖ **Persistent Sidecar** with minimize/restore/pin features - NEVER lose your prompt details!
‚úÖ **Pin panel** to keep it open while you work
‚úÖ **Minimize to tab** when you need more screen space
‚úÖ **ZERO manual pasting** - completely automatic!

---

## Installation (5 Minutes)

### 1. Install Tampermonkey Extension

**Chrome:**
1. Go to: https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo
2. Click "Add to Chrome"

**Edge:**
1. Go to: https://microsoftedge.microsoft.com/addons/detail/tampermonkey/iikmkjmpaadaobahmlepeloendndfphd
2. Click "Get"

### 2. Install SPARK Integration Script

1. **Click Tampermonkey icon** in toolbar
2. Select **"Create a new script..."**
3. **DELETE ALL** default code
4. **Open this file**: `/home/aiwithnick/SPARK_LIBRARY_FLUENT_UI_VERSION/m365-copilot-spark-integration.user.js`
5. **Copy EVERYTHING** (all ~829 lines - v3.0.0 with minimize/restore/pin!)
6. **Paste into Tampermonkey**
7. **Save** (File ‚Üí Save or Ctrl+S)
8. ‚úÖ Script should show as ENABLED

### 3. Start SPARK Library

```bash
cd /home/aiwithnick/SPARK_LIBRARY_FLUENT_UI_VERSION
npm start
```

Verify it's running:
- Frontend: http://localhost:3000 ‚úÖ
- API: http://localhost:3001/api/prompts ‚úÖ

---

## How To Use

### Step 1: Go to M365 Copilot
Open: **https://m365.cloud.microsoft/chat/**

Wait 2-3 seconds ‚Üí You'll see a **‚ö° floating button** (bottom-right corner)

### Step 2: Click ‚ö° Button
The SPARK library opens in a new tab

### Step 3: Find a Prompt
- Browse departments
- Search for keywords
- Click any prompt card

### Step 4: Click "Copy to Copilot"
Purple gradient button on the prompt page

### Step 5: Switch Back to Copilot Tab
**BOOM! The prompt is ALREADY THERE!**

‚úÖ Full prompt text in chatbox (4,000+ characters)
‚úÖ Sidecar panel on right with ALL details:
- ‚öôÔ∏è What This Prompt Does
- üí° Tips
- ‚ùì How To Use This Prompt
- üì• Example Input
- üì§ Example Output (images)

### Step 6: Work with the Sidecar Panel (NEW in v3.0.0!)

The sidecar now has **3 powerful buttons** in the header:

#### **üìå Pin Button** (Left) - MOST IMPORTANT!
- Click to **pin** the sidecar
- When pinned:
  - **Overlay DISAPPEARS** (dark backdrop removed)
  - Icon rotates 45¬∞ and highlights
  - Sidecar floats on right side
  - **YOU CAN NOW INTERACT WITH COPILOT!**
  - **Type messages, send to LLM, scroll, click anywhere**
  - Sidecar stays visible as reference panel
  - Perfect for keeping prompt details visible while chatting with AI
- Click again to unpin (overlay reappears)

#### **‚ûñ Minimize Button** (Middle)
- Click to **minimize** sidecar to a small tab
- Tab appears on right edge: "üìã Prompt Details"
- All content stays in memory (nothing lost!)
- Great when you need more screen space
- Click the tab anytime to restore

#### **‚úï Close Button** (Right)
- Also minimizes to tab (doesn't destroy content!)
- Same as clicking ‚ûñ
- Press **ESC** key for keyboard shortcut (when unpinned)

#### **Workflows:**

**Option A: Keep Sidecar Open While Working (RECOMMENDED!)**
1. Click **üìå Pin** button
2. **Overlay disappears** - dark backdrop removed
3. Sidecar floats on right side
4. **NOW YOU CAN USE COPILOT!**
   - Type in the chatbox
   - Send messages to the LLM
   - Have full conversations with AI
   - Scroll, click, interact with everything
5. Sidecar stays visible as reference (see tips, examples, how-to-use)
6. Click **üìå** again to unpin when done (overlay comes back)

**Option B: Minimize When You Need Space**
1. Click **‚ûñ** or **‚úï** to minimize
2. Sidecar slides out, tab appears on right edge
3. Work in Copilot with full screen
4. Click **üìã Prompt Details** tab to restore anytime
5. All content is exactly as you left it!

**Option C: Quick Toggle with Overlay/ESC**
- When **unpinned**: Click outside sidecar or press ESC ‚Üí Minimizes to tab
- When **pinned**: No overlay to click (it's hidden!), ESC does nothing ‚Üí Sidecar stays open while you work in Copilot

### Step 7: Customize & Send
Edit placeholders (like [COMPANY NAME]) and hit Send!

---

## What the Sidecar Shows (EXACT Match to Library)

The sidecar displays in this EXACT order (matching ViewPage.jsx):

1. **Header**
   - Icon + Title
   - Department badge
   - Complexity level
   - Word count
   - Subcategory (if available)
   - Description

2. **‚öôÔ∏è What This Prompt Does** (purple card)
   - Bullet list explaining capabilities

3. **üí° Tips** (golden gradient card)
   - Pro tips for best results

4. **‚ùì How To Use This Prompt** (purple card)
   - Step-by-step instructions

5. **üì• Example Input** (green card)
   - Sample inputs you can use

6. **üì§ Example Output** (pink card)
   - IMAGE GALLERY showing example results
   - Click images to open full size

7. **Success Message** (green card)
   - "‚úÖ Prompt inserted into Copilot!"

---

## Technical Details

### How It Works

```
1. M365 Copilot Tab
   ‚Üì
2. Click ‚ö° button ‚Üí Opens SPARK library (new tab)
   ‚Üì
3. SPARK library (window.opener = Copilot tab)
   ‚Üì
4. Click "Copy to Copilot" ‚Üí Sends postMessage
   ‚Üì
5. Tampermonkey script receives message
   ‚Üì
6. insertPromptText() - NUCLEAR INSERTION:
   - Tries 5 different selectors to find input
   - Sets text with textContent, innerText, innerHTML
   - Creates text nodes + <br> tags
   - Dispatches 11 different events
   - Finds React instance and calls onChange
   - Sets cursor position
   ‚Üì
7. openSidecar() - Shows ALL metadata
   ‚Üì
8. ‚úÖ Prompt in chatbox + Sidecar visible!
```

### Insertion Methods Used (All Simultaneously)

The script tries EVERYTHING at once:

1. **Direct DOM manipulation**
   - `p.textContent = formattedPrompt`
   - `p.innerText = formattedPrompt`
   - `p.innerHTML = formattedPrompt.replace(/\n/g, '<br>')`

2. **Text node creation**
   - Creates actual DOM text nodes
   - Inserts `<br>` tags for line breaks

3. **Event dispatching**
   - beforeinput, input, textInput
   - focus, focusin, click
   - change, keydown, keypress, keyup, blur

4. **React instance manipulation**
   - Finds `__reactFiber`, `__reactProps`, or `__reactInternalInstance`
   - Calls `onChange({ target: { value: formattedPrompt } })`

5. **Cursor positioning**
   - Sets selection to end of text

### Multiple Selector Fallback

Tries these selectors in order:
1. `#m365-chat-editor-target-element`
2. `[contenteditable="true"][role="textbox"]`
3. `[contenteditable="true"]`
4. `div[class*="editor"]`
5. `div[class*="input"]`

If all fail ‚Üí Uses first contenteditable element found

---

## Troubleshooting

### ‚ùå No floating button

**Fix:**
1. Is Tampermonkey enabled? (icon colorful, not gray)
2. Refresh M365 Copilot page (Ctrl+R)
3. Check console (F12): Should see `[Spark] ‚ö° Integration v2.0.0 complete!`

### ‚ùå Prompt doesn't appear in chatbox

**Debug:**
1. Open console (F12) on M365 Copilot tab
2. Click "Copy to Copilot" in library
3. Look for these logs:
   - `[Spark] ‚úì Found input with selector: ...`
   - `[Spark] Inserting XXXX characters...`
   - `[Spark] ‚úì Insertion complete - checking in 1 second...`
   - `[Spark] ‚úÖ ‚úÖ ‚úÖ SUCCESS! TEXT IS IN THE CHATBOX!`

**If you see "‚ùå FAILED - Text not persisting":**
- Microsoft changed the input structure
- Console will show what element was found
- Send me the console output to fix the selectors

### ‚ùå Sidecar doesn't open

**Check:**
1. Did prompt successfully insert?
2. Console should show: `[Spark] ‚úì Sidecar opened: [Prompt Title]`
3. Check if elements exist:
   - F12 ‚Üí Elements tab
   - Search for `spark-sidecar`
   - Check `style.right` (should be "0")
   - Check `style.display` (should be "block")

### ‚ùå Missing data in sidecar

**Check:**
1. Does the prompt have metadata?
2. Console: Look for message received
3. Expand the `promptDetails` object
4. Verify `metadata.whatItDoes`, `metadata.howToUse`, etc. exist

---

## Console Logs Reference

### ‚úÖ Successful Insertion (v3.0.0)

```
[Spark] Initializing M365 Copilot integration v3.0.0...
[Spark] ‚úì Draggable floating button added
[Spark] ‚úì Beautiful sidecar panel created with minimize/restore/pin
[Spark] ‚úì Message listener ready
[Spark] ‚ö° Integration v3.0.0 complete!
[Spark] ‚úì Draggable button
[Spark] ‚úì Persistent sidecar (minimize/restore/pin)
[Spark] ‚úì Formatted prompts
[Spark] ‚úì Opens in Chrome tab

[Spark] ‚úì Found input with selector: #m365-chat-editor-target-element
[Spark] Inserting 4078 characters...
[Spark] Found React key: __reactFiber$oevtjdiojd
[Spark] React instance: Object { ... }
[Spark] ‚úì Insertion complete - checking in 1 second...
[Spark] Current text length: 4078
[Spark] Expected length: 4078
[Spark] Preview: #CONTEXT: You are a financial planning AI assistant...
[Spark] ‚úÖ ‚úÖ ‚úÖ SUCCESS! TEXT IS IN THE CHATBOX!
[Spark] ‚úì Sidecar opened: Achieve Sustainable Wealth Strategies
```

### ‚úÖ Minimize/Restore Logs (NEW!)

```
[Spark] ‚úì Sidecar minimized to tab
[Spark] ‚úì Sidecar restored: Achieve Sustainable Wealth Strategies
```

### ‚úÖ Pin/Unpin Logs (NEW!)

```
[Spark] ‚úì Sidecar pinned - overlay hidden, user can interact with Copilot
[Spark] ‚úì Sidecar unpinned - overlay visible again
```

### ‚ùå Failed Insertion

```
[Spark] ‚ùå Could not find ANY input element!
[Spark] All contenteditable elements: NodeList []
[Spark] ‚ùå FAILED: Cannot find Copilot input field!
```

OR

```
[Spark] ‚úì Found input with selector: #m365-chat-editor-target-element
[Spark] Inserting 4078 characters...
[Spark] ‚úì Insertion complete - checking in 1 second...
[Spark] Current text length: 0
[Spark] Expected length: 4078
[Spark] ‚ùå FAILED - Text not persisting
[Spark] DOM innerHTML: <p><br></p>
[Spark] DOM textContent:
```

---

## Files Reference

| File | Purpose |
|------|---------|
| `m365-copilot-spark-integration.user.js` | **Main script v3.0.0 - Install this in Tampermonkey** |
| `SIDECAR_V3_FEATURES.md` | **NEW! Complete v3.0.0 feature documentation** |
| `src/components/ViewPage.jsx` | Sends prompt data via postMessage |
| `COMPLETE_SETUP_GUIDE.md` | This file |
| `INSTALLATION_INSTRUCTIONS.md` | Installation guide |
| `DEBUG_SCRIPT.md` | Debugging notes |

---

## Version Info

**Script Version:** 3.0.0
**Last Updated:** 2025-10-21
**Status:** ‚úÖ PRODUCTION READY - Persistent Sidecar with Minimize/Restore/Pin!

---

## What's New in v3.0.0

‚úÖ **Persistent Sidecar** - Never lose prompt details again!
‚úÖ **Minimize to Tab** - "üìã Prompt Details" tab on right edge
‚úÖ **Restore from Tab** - Click tab to bring back full sidecar
‚úÖ **Pin Panel** - Keep sidecar open while clicking outside
‚úÖ **Smooth Animations** - Matches SPARK library design system
‚úÖ **3-Button Header** - üìå Pin, ‚ûñ Minimize, ‚úï Close
‚úÖ **State Persistence** - Content stays in memory across minimize/restore
‚úÖ **Visual Feedback** - Pin icon rotates 45¬∞, tab hover effects
‚úÖ **Keyboard Shortcuts** - ESC minimizes (when unpinned)
‚úÖ **Professional Polish** - Clean, sleek, production-ready

## What's Fixed (Previous Versions)

‚úÖ **Sidecar matches library exactly** - Same order, same sections, same styling
‚úÖ **Example Output shows IMAGES** - Not text, actual image grid
‚úÖ **No manual pasting** - Completely automatic insertion
‚úÖ **Nuclear insertion** - 5 methods simultaneously
‚úÖ **React bypass** - Finds and calls React onChange directly
‚úÖ **Multiple selectors** - Tries 5 different ways to find input
‚úÖ **Detailed logging** - Every step logged with ‚úÖ/‚ùå
‚úÖ **Verification** - Checks text actually persisted

---

## Success Criteria

When everything works correctly, you'll see:

1. ‚ö° **Floating button** on M365 Copilot (draggable, bottom-right)
2. **Library opens** when you click button (new tab)
3. **Prompt auto-inserts** into chatbox (NO manual pasting!)
4. **Sidecar slides in** from right with ALL details
5. **3 buttons** in sidecar header: üìå Pin, ‚ûñ Minimize, ‚úï Close
6. **Click ‚ûñ or ‚úï** ‚Üí Sidecar minimizes to "üìã Prompt Details" tab
7. **Click tab** ‚Üí Sidecar restores with same content
8. **Click üìå** ‚Üí Pin icon rotates 45¬∞, sidecar stays open
9. **Clicking outside** (unpinned) ‚Üí Minimizes to tab
10. **ESC key** (unpinned) ‚Üí Minimizes to tab
11. **Images display** in Example Output section
12. **Send button** is active/blue in Copilot
13. **All animations smooth** and polished
14. **Ready to customize** and send!

---

## Browser Compatibility

‚úÖ **Chrome** - Fully tested
‚úÖ **Edge** - Fully tested
‚ö†Ô∏è **Firefox** - Not tested (Tampermonkey required)
‚ùå **Safari** - Not supported (no Tampermonkey)

---

## Support

If it doesn't work:

1. **Check console** (F12) for [Spark] logs
2. **Verify SPARK running** on localhost:3000
3. **Check Tampermonkey** script is enabled
4. **Try different prompt** (some may have no metadata)
5. **Refresh both tabs** and try again
6. **Clear browser cache** and reinstall script

---

## What You Should See

### Before (M365 Copilot):
- Empty chatbox
- ‚ö° button bottom-right

### After "Copy to Copilot":
- **Chatbox:** Full prompt (4,000+ chars, formatted)
- **Right side:** Sidecar panel with:
  - Icon, title, badges
  - What It Does (purple)
  - Tips (golden)
  - How To Use (purple)
  - Example Input (green)
  - Example Output (pink with images)
  - Success message (green)
- **Send button:** Active/blue
- **NO manual pasting needed!**

---

**END OF GUIDE**
